<%= tag.section class: "panel", data: (@room.active? ? { controller: "campfire", campfire_room_id_value: @room.id, campfire_mic_mode_value: (current_user.mic_mode.presence || "push_to_talk"), campfire_voice_token_url_value: voice_token_campfire_path(@room) } : {}) do %>
  <div class="panel-header">
    <h1><%= @room.name %></h1>
    <span class="muted mono">Room <%= @room.id %></span>
  </div>

  <% if @room.active? %>
    <div class="campfire-controls">
      <div class="campfire-voice-actions">
        <button
          class="button button-compact button-voice-toggle button-voice-join"
          data-action="campfire#toggleVoice"
          data-campfire-target="voiceToggle"
        >
          Join Voice
        </button>
        <details class="campfire-room-menu">
          <summary class="button button-muted button-compact">Room Menu</summary>
          <div class="campfire-room-menu-panel">
            <div class="campfire-voice-meta">
              <label class="muted mono" for="campfire-mic-mode">Mic</label>
              <select
                id="campfire-mic-mode"
                class="select-compact mono"
                data-campfire-target="micModeSelect"
                data-action="campfire#changeMicMode"
              >
                <option value="push_to_talk">Push to talk</option>
                <option value="open_mic">Open mic</option>
              </select>
              <span class="muted mono" data-campfire-target="voiceModeHint"></span>
            </div>
          </div>
        </details>
        <details class="campfire-help-menu">
          <summary class="button button-muted button-compact">Help</summary>
          <div class="campfire-room-menu-panel">
            <span class="muted mono">Audio not playing?</span>
            <button
              class="button button-muted button-compact"
              data-action="campfire#enableAudio"
              data-campfire-target="audioButton"
              hidden
            >
              Enable Audio
            </button>
          </div>
        </details>
      </div>
      <div class="campfire-controls-right">
        <% if @room.created_by_id == current_user.id && @room.active? %>
          <%= button_to "Close campfire", close_campfire_path(@room), method: :patch, class: "button button-warn button-compact" %>
        <% end %>
        <%= link_to "Back to chat", chat_path, class: "button button-muted button-compact" %>
      </div>
    </div>

    <div class="campfire-presence">
      <div class="campfire-presence-header">
        <div class="campfire-presence-title">
          <span class="muted">Connected</span>
          <span class="muted" data-campfire-target="presenceCount"></span>
        </div>
      </div>
      <ul class="presence-list" data-campfire-target="peerList"></ul>
    </div>
  <% else %>
    <p class="muted">Campfire closed. Viewing read-only history.</p>
    <%= link_to "Back to chat", chat_path, class: "button button-muted button-compact" %>
  <% end %>

  <%= turbo_stream_from "chat_user_colors" %>
  <%= render "chat_messages/user_colors", users: @chat_users %>

  <div class="campfire-shell">
    <div class="campfire-pane">
      <%= turbo_stream_from [@room, :campfire_messages] %>

      <div
        class="chat-log"
        id="campfire_messages"
        data-controller="chat-scroll"
        data-chat-scroll-container-value="true"
      >
        <%= render partial: "campfire_messages/message", collection: @messages, as: :message %>
      </div>

      <% if @room.active? %>
        <div class="chat-composer" id="campfire_message_form">
          <%= render "campfire_messages/form", room: @room, message: @message %>
        </div>
      <% end %>
    </div>
  </div>

  <div class="campfire-audio"></div>
<% end %>
